{% extends "base.html" %} 
{% block content %}

<style>
    /* Existing styles */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
        from { opacity: 1; }
        to { opacity: 0; }
    }
    #chat-box {
        max-height: 300px;
        overflow-y: auto;
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 8px;
        width: 100%;
    }
    #chat-container {
        width: 100%;
        max-width: 600px;
        margin: auto;
        animation: fadeIn 0.5s ease-out;
    }
    .message {
        padding: 10px;
        margin: 5px 0;
        border-radius: 5px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        animation: fadeIn 0.5s ease-out;
        display: flex;
        align-items: center;
    }
    .message.user { background-color: #d1ecf1; text-align: right; justify-content: flex-end; }
    .message.ai { background-color: #fefefe; text-align: left; justify-content: flex-start; }
    .message-icon { margin-right: 10px; }
    .message.user .message-icon { margin-left: 10px; margin-right: 0; }
    #freeform-container { margin-top: 20px; }
    #question-box, #response-box {
        max-height: 200px;
        overflow-y: auto;
        padding: 10px;
        border-radius: 8px;
        width: 100%;
    }
    #question-box { background-color: #f0f0f0; border: 1px solid #ccc; }
    #response-box { background-color: #e6ffed; border: 1px solid #b8f0c9; margin-top: 10px; }
    .difficulty-icon.easy { color: #28a745; }
    .difficulty-icon.medium { color: #fd7e14; }
    .difficulty-icon.hard { color: #dc3545; }
    #question-input { background-color: #f0f0f0; border: 1px solid #ccc; }
    #send-btn { background-color: #4CAF50; border-color: #4CAF50; }
    #send-btn:hover { background-color: #45a049; }
    
    /* New styles for problem display and explanation */
    #problem-container {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }
    #explanation-box {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        border-radius: 8px;
        padding: 15px;
        margin-top: 15px;
        display: none;
    }
</style>

<div class="container mx-auto mt-10 px-4">
    <h1 class="text-4xl font-bold text-gray-800 mb-4 flex items-center justify-center">
        <i class="fas fa-robot mr-2 text-blue-500"></i> AI Math Interaction
    </h1>

    <div id="chat-container" class="bg-white shadow-md rounded-lg p-6 w-full md:w-2/3 lg:w-1/2 mx-auto">
        <div id="chat-box" class="overflow-y-auto mb-4 p-3 bg-gray-100" style="height: 300px; border: 1px solid #ddd; border-radius: 8px;">
            <!-- Chat messages will be appended here -->
        </div>

        <div class="mb-4">
            <label for="difficulty" class="block mb-2 font-semibold text-gray-700">
                <i id="difficulty-icon" class="fas fa-signal mr-1 difficulty-icon"></i> Difficulty:
            </label>
            <select id="difficulty" class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200">
                <option value="easy" data-icon="easy">Easy</option>
                <option value="medium" data-icon="medium">Medium</option>
                <option value="hard" data-icon="hard">Hard</option>
            </select>
        </div>

        <button id="generate-btn" class="w-full text-white bg-blue-500 hover:bg-blue-700 transition duration-300 font-bold py-2 px-4 rounded shadow-md transform hover:scale-105">
            <i class="fas fa-cogs mr-2"></i> Generate Problem
        </button>
        
        <div id="problem-container" class="mt-4 p-4 bg-gray-100 rounded-lg">
            <!-- Generated problem and options will be displayed here -->
        </div>
        
        <div id="explanation-box" class="mt-4 p-4 bg-gray-200 rounded-lg">
            <!-- Explanation will be displayed here -->
        </div>
        
        <div id="freeform-container" class="mt-6">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Ask a Question</h2>
            
            <div class="flex flex-col">
                <textarea id="question-input" class="w-full px-3 py-2 border rounded resize-none mb-2" rows="4" placeholder="Type your question here..."></textarea>
            </div>

            <div id="response-box" class="mt-4">
                <!-- AI responses will be appended here -->
            </div>
        </div>
    </div>
</div>

<script>
    const chatBox = document.getElementById('chat-box');
    const difficultySelect = document.getElementById('difficulty');
    const generateBtn = document.getElementById('generate-btn');
    const difficultyIcon = document.getElementById('difficulty-icon');
    const questionInput = document.getElementById('question-input');
    const problemContainer = document.getElementById('problem-container');
    const explanationBox = document.getElementById('explanation-box');
    const courseName = '{{ course_name }}';
    console.log('Course name:', courseName);

    function updateDifficultyIcon() {
        const selectedOption = difficultySelect.options[difficultySelect.selectedIndex];
        const difficulty = selectedOption.value;
        difficultyIcon.classList.remove('easy', 'medium', 'hard');
        difficultyIcon.classList.add(difficulty);
    }

    function addMessage(content, type) {
        const message = document.createElement('div');
        message.classList.add('message', type);
        const icon = type === 'user' ? '<i class="fas fa-user message-icon"></i>' : '<i class="fas fa-robot message-icon"></i>';
        message.innerHTML = `${icon}<strong>${type === 'user' ? 'You' : 'AI'}:</strong> ${content}`;
        chatBox.appendChild(message);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

function displayProblem(data) {
    if (!data.problem) {
        addMessage("AI: Error: The generated problem is empty. Please try again.", 'ai');
        return;
    }

    let optionsHtml = '';
    if (Array.isArray(data.options) && data.options.length > 0) {
        optionsHtml = data.options.map((option, index) => `
            <label class="block mb-2">
                <input type="radio" name="answer" value="${option.split(')')[0]}" class="mr-2">
                ${option}
            </label>
        `).join('');
    } else {
        console.error('Options are not in the expected format:', data.options);
        addMessage("AI: Error: The generated options are not in the correct format. Please try again.", 'ai');
        return;
    }

    problemContainer.innerHTML = `
        <p class="font-bold mb-2">Problem:</p>
        <p class="mb-4">${data.problem}</p>
        <form id="answer-form">
            ${optionsHtml}
            <button type="submit" class="mt-4 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Submit Answer
            </button>
        </form>
    `;
    problemContainer.dataset.problemId = data.id;
    addMessage(`AI: Here's a ${difficultySelect.value} ${courseName} problem for you:`, 'ai');
    addMessage(data.problem, 'ai');
}

generateBtn.addEventListener('click', () => {
    const difficulty = difficultySelect.value;
    const courseName = "{{ course_name }}";

    addMessage(`You: Generate a ${difficulty} ${courseName} problem`, 'user');

    const requestData = { 
        course_name: courseName,
        difficulty: difficulty
    };

    console.log('Sending request with data:', requestData);

    fetch('/generate_problem', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token() }}'
        },
        body: JSON.stringify(requestData)
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.error || `HTTP error! status: ${response.status}`);
            }
            return data;
        });
    })
    .then(data => {
        console.log('Received data:', data);
        if (data.problem) {
            displayProblem(data);
        } else {
            addMessage('Problem generation failed. Please try again.', 'ai');
        }
    })
    .catch(error => {
        console.error('Fetch error:', error);
        addMessage(`Error: ${error.message}`, 'ai');
    });
});

// Add event listener for answer submission
document.addEventListener('submit', function(event) {
    if (event.target.id === 'answer-form') {
        event.preventDefault();
        const formData = new FormData(event.target);
        const answerLetter = formData.get('answer');
        const problemId = problemContainer.dataset.problemId;

        // Get the full text of the answer
        const answerFull = document.querySelector(`input[name="answer"][value="${answerLetter}"]`).nextSibling.textContent.trim();

        console.log('Submitting answer:', { problem_id: problemId, answer: answerFull });

        // Display the user's answer in the chat box
        addMessage(`You: My answer is ${answerFull}`, 'user');

        fetch('/submit_answer', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ 
                problem_id: problemId,
                answer: answerFull
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('Received response:', data);
            if (data.error) {
                addMessage(`AI: Error: ${data.error}`, 'ai');
            } else {
                // Display the explanation from the response
                addMessage(`AI: ${data.explanation}`, 'ai');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            addMessage(`AI: An error occurred while submitting your answer: ${error.message}`, 'ai');
        });
    }
});

   questionInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            const question = questionInput.value.trim();

            if (question) {
                addMessage(`You: ${question}`, 'user');

                fetch('/get_feedback', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token() }}'
                    },
                    body: JSON.stringify({ 
                        student_input: question, 
                        problem: null, 
                        course: '{{ course_name }}' 
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.response) {
                        addMessage(`AI: ${data.response}`, 'ai');
                    } else {
                        addMessage('Failed to get response. Please try again.', 'ai');
                    }
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    addMessage(`Error: ${error.message}`, 'ai');
                });

                questionInput.value = '';
            }
        }
    });

    difficultySelect.addEventListener('change', updateDifficultyIcon);

    // Initialize icon based on the default selected option
    updateDifficultyIcon();

</script>

{% endblock %}